# Руководство по интеграции Server-to-Server трекера Admitad

Здравствуйте!

Это руководство поможет вам быстро и надёжно настроить серверную интеграцию с Admitad. Данное решение повышает точность отслеживания конверсий до 99%, защищает трекинг от блокировщиков рекламы и обеспечивает корректную атрибуцию заказов по модели **Last Paid Click**.

Процесс интеграции не требует глубоких изменений в коде вашего проекта и состоит из нескольких простых шагов.

---
### Оглавление
1.  [Как это работает?](#1-как-это-работает)
2.  [Шаг 1: Установка плагина](#2-шаг-1-установка-плагина)
3.  [Шаг 2: Подключение плагина к вашему приложению](#3-шаг-2-подключение-плагина-к-вашему-приложению)
4.  [Шаг 3: Настройка конфигурации](#4-шаг-3-настройка-конфигурации)
5.  [Шаг 4: Подключение скрипта на сайт](#5-шаг-4-подключение-скрипта-на-сайт)
6.  [Шаг 5: Проверка интеграции](#6-шаг-5-проверка-интеграции)
7.  [Приложение A: Настройка dataLayer](#приложение-a-настройка-dataLayer)
8.  [Приложение Б: Технические детали и автономность](#приложение-б-технические-детали-и-автономность)
9.  [Как отключить плагин](#как-отключить-плагин)

---
## 1. Как это работает?

Интеграция состоит из двух компонентов: **клиентского скрипта** (`int_loader.js`), который работает в браузере пользователя, и **серверного плагина** (`admitad_postback_plugin`), который взаимодействует с Admitad.

1.  **Визит пользователя**: Скрипт на вашем сайте "ловит" параметры `admitad_uid` из партнёрской ссылки.
2.  **Установка Cookie**: Скрипт отправляет `admitad_uid` на ваш сервер (плагин), который устанавливает безопасные **HttpOnly cookie**. Это защищает данные от кражи.
3.  **Конверсия**: Когда пользователь совершает покупку, ваш сайт сообщает об этом в `dataLayer`. Скрипт собирает данные о заказе и отправляет их на ваш сервер.
4.  **Дедупликация и Postback**: Ваш сервер (плагин) проверяет cookie. Если последний переход был из Admitad, он отправляет **серверный (S2S) postback-запрос** в Admitad, подтверждая конверсию.

---
## 2. Шаг 1: Установка плагина

1.  **Скопируйте папку** `admitad_postback_plugin` в директорию с кодом вашего бэкенда.
    * *Рекомендация для Python-проектов: поместите её в папку `backend/`.*

2.  **Установите зависимости**. Убедитесь, что в вашем проекте установлены следующие библиотеки (или их аналоги для вашего языка):
    * `requests` — для отправки postback-запросов.
    * `python-dotenv` — для безопасной работы с конфигурационными файлами.
    * *Для Python: добавьте эти зависимости в ваш файл `requirements.txt` и выполните `pip install -r requirements.txt`.*

---
## 3. Шаг 2: Подключение плагина к вашему приложению

Теперь нужно "сообщить" вашему основному приложению о существовании плагина.

### Пример для Python (FastAPI):
В вашем основном файле (`main.py`) добавьте две строки для импорта и подключения роутера плагина.

```python
# main.py
from fastapi import FastAPI
# ... другие импорты

# 1. Импортируйте роутер из плагина
from backend.admitad_postback_plugin import admitad_integration

app = FastAPI()

# ... другая логика вашего приложения

# 2. Подключите роутер плагина с нейтральным префиксом
app.include_router(admitad_integration.router, prefix="/s")
```
* **Почему префикс `/s/`?** Мы используем нейтральный путь, чтобы минимизировать риск блокировки скрипта браузерными расширениями.

---
## 4. Шаг 3: Настройка конфигурации

1.  **Создайте файл конфигурации**. Скопируйте файл `.admitad.env.example`, который находится внутри плагина, и переименуйте копию в `.admitad.env`.

2.  **Заполните переменные** в файле `.admitad.env`:

    ```env
    # Код вашей рекламной кампании из личного кабинета Admitad.
    ADMITAD_CAMPAIGN_CODE="YOUR_CAMPAIGN_CODE"

    # Секретный ключ для postback-запросов из личного кабинета.
    ADMITAD_POSTBACK_KEY="YOUR_POSTBACK_KEY"
    
    # Код целевого действия "Продажа", созданный в личном кабинете.
    # Рекомендуемое значение: sale, 1, 2 и т.д.
    DEFAULT_ACTION_CODE="sale"
    
    # Код тарифа по умолчанию.
    DEFAULT_TARIFF_CODE="1"
    
    # Валюта по умолчанию (ISO 4217).
    DEFAULT_CURRENCY_CODE="RUB"
    
    # Срок жизни cookie в днях.
    COOKIE_LIFETIME_DAYS=90
    
    # --- Настройки для отладки ---
    # Уровень логирования: DEBUG (для отладки), INFO (для рабочего сайта)
    ADMITAD_LOG_LEVEL=INFO
    ```

* **Важно:** Файл `.admitad.env` содержит секретные ключи. Убедитесь, что он добавлен в ваш `.gitignore` и не попадёт в систему контроля версий. В плагине уже есть локальный `.gitignore` для этого.

---
## 5. Шаг 4: Подключение скрипта на сайт

Добавьте следующую строку на **все страницы** вашего сайта, желательно внутри тега `<head>`:

```html
<script src="/s/main.js" async></script>
```
---
## 6. Шаг 5: Проверка интеграции

После выполнения всех шагов перезапустите ваш сервер и проведите тестовый заказ.

1.  **Проверка установки Cookie**: Перейдите по тестовой партнёрской ссылке Admitad (с параметром `admitad_uid`). В инструментах разработчика браузера (вкладка `Application` -> `Cookies`) убедитесь, что установились cookie **`_adm_aid`** и **`_last_source`** с флагом `HttpOnly`.

2.  **Проверка `dataLayer`**: На странице подтверждения заказа введите в консоли `dataLayer` и убедитесь, что в массиве есть событие `purchase` (или аналог) с данными о заказе.

3.  **Проверка логов**: Откройте лог-файл плагина (по умолчанию `admitad_tracker.log` внутри папки плагина). После тестового заказа там должны появиться записи об атрибуции и успешной отправке postback-запроса.

4.  **Проверка в Admitad**: В личном кабинете в статистике по конверсиям в течение 15-30 минут должен появиться тестовый заказ.

---
## Приложение A: Настройка `dataLayer`

Трекер работает в двух режимах:

* **Режим 1: `dataLayer` существует (стандартный)**
    Если на вашем сайте уже настроена веб-аналитика, трекер автоматически обнаружит стандартное событие `purchase` и соберёт все необходимые данные. Убедитесь, что структура события соответствует стандарту Google Ecommerce.

* **Режим 2: `dataLayer` отсутствует (кастомная настройка)**
    Если `dataLayer` не используется, вы можете передать данные о заказе напрямую. Для этого на странице подтверждения заказа вызовите JavaScript-функции трекера:
    ```javascript
    // 1. Настройте источник данных
    window.admitadTracker.configure({
        getOrderId: () => "ID_ВАШЕГО_ЗАКАЗА",
        getOrderAmount: () => СУММА_ВАШЕГО_ЗАКАЗА,
        // ... и другие поля
    });
    // 2. Запустите трекинг
    window.admitadTracker.triggerPurchase();
    ```

* **Важно:** Все детали по настройке JavaScript-части трекера (включая отключение `sessionStorage` или изменение имён событий) находятся в комментариях внутри файла `int_loader.js`.

---
## Приложение Б: Технические детали и автономность

* **Устойчивость к сбоям**: Если API Admitad будет временно недоступен, это не повлияет на работу вашего сайта. Ошибка будет записана в лог, а пользователь не заметит никаких проблем.

* **Масштабируемость**: Плагин написан с использованием асинхронных практик и готов к высоким нагрузкам.

* **Изоляция**: Плагин полностью автономен. Он использует собственную конфигурацию, ведёт собственный лог-файл и не вмешивается в работу основного приложения.

---
## Как отключить плагин

Если вам понадобится временно отключить или полностью удалить трекер, следуйте этим инструкциям.

### Способ 1: Временное отключение (рекомендуемый)
Этот способ позволяет быстро "выключить" трекер, не удаляя файлы.

1.  **На бэкенде**: В файле `main.py` закомментируйте строку, которая подключает роутер плагина.
    ```python
    # app.include_router(admitad_integration.router, prefix="/s")
    ```
2.  **На фронтенде**: В главном HTML-шаблоне вашего сайта закомментируйте строку, которая подключает скрипт.
    ```html
    <script src="/s/main.js" async></script>
    ```
3.  **Перезапустите сервер**. После этого API-эндпоинты трекера перестанут существовать, а скрипт перестанет загружаться.

### Способ 2: Полное удаление

1.  Выполните все действия из **Способа 1**.
2.  Удалите папку `admitad_postback_plugin` из вашего проекта.
3.  (Опционально) Если какие-то из зависимостей использовались только для трекера, вы можете удалить их из `requirements.txt`.